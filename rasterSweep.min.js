!function(){"use strict";function e(){return{recolorBorder:function(t,a,i){var r=e(100,t,a);i.css("border-color",r)},clipOverlayImage:function(e,t,a,i,r){var s=r,o=a[0].width-e-i-t,n=a[0].height-e-r-t,l=i;a.css("clip-path","inset("+s+"px "+o+"px "+n+"px "+l+"px)"),a.css("opacity","1")},moveSweeper:function(e,t,a){e.css("left",t+"px"),e.css("top",a+"px")},checkBoundaries:function(e,t,a,i){a>e[0].width-t&&(a=e[0].width-t);a<e[0].offsetLeft&&(a=e[0].offsetLeft);i>e[0].height-t&&(i=e[0].height-t);i<e[0].offsetTop&&(i=e[0].offsetTop)},getHSLColor:function(e,t){var a=120-e/(t*t)*120;if(a>100){var i=a-100,r=50+3*i;return"hsl("+a+", 100%, "+r+"%)"}return"hsl("+a+", 100%, 50%)"},getSingleColorPalette:e};function e(e,t,a){var i;return(i=100-100*(t/(a*a)))<80?"hsl("+e+", 100%, "+(i=60-(60-i)/4.5)+"%)":"hsl("+e+", 100%, "+i+"%)"}}function t(e,t){return{restrict:"E",scope:{base:"@rsBase",overlay:"@rsOverlay"},template:'<div class="raster-wrapper"><canvas class="rs-canvas" id="rasterSweepCanvas" height="301px" width="450px"></canvas><canvas class="rs-canvas" id="diffCanvas" height="301px" width="450px"></canvas><canvas class="rs-canvas" id="rasterSweepCanvasBg" height="301px" width="450px"></canvas><img id="rs-btn-image" ng-src="{{base}}" alt="original" /><img id="rs-top-image" ng-src="{{overlay}}" alt="original" /><div id="rs-glass"></div><div id="rs-digitiser"></div></div>',link:function(t,a,i,r,s){if(!t.base)throw"no base path defined";if(!t.overlay)throw"no overlay path defined";t.$watch("overlay",function(i){console.log("changed overlay path to "+i);t.base,t.overlay;var r=a.find("#rasterSweepCanvas")[0],s=r.getContext("2d"),o=a.find("#rasterSweepCanvasBg")[0],n=o.getContext("2d"),l=a.find("#diffCanvas")[0],h=l.getContext("2d"),f=h.createImageData(r.width,r.height),c=r.width/2,d=r.height/2;function p(e,t,a,i){for(var r=t+i,s=a+i,o=0,n=t;n<r;n++)for(var l=a;l<s;l++){var h=e.getImageData(n,l,1,1).data[0];0===h&&(o+=1)}return o}s.beginPath(),s.arc(c,d,70,0,2*Math.PI,!1),s.fillStyle="green",s.fill(),s.lineWidth=5,s.strokeStyle="#003300",s.stroke(),s.beginPath(),s.lineWidth="4",s.fillStyle="red",s.fill(),s.strokeStyle="green",s.fillRect(30,30,50,50),s.stroke(),n.beginPath(),n.arc(c,d,40,0,2*Math.PI,!1),n.fillStyle="green",n.fill(),n.lineWidth=1,n.strokeStyle="#003300",n.stroke(),setTimeout(function(){var e,t,a,i;h.putImageData((e=f,t=n,a=s.getImageData(0,0,r.width,r.height),i=t.getImageData(0,0,r.width,r.height),pixelmatch(a.data,i.data,e.data,r.width,r.height,{threshold:.1}),e),0,0)},300);var g,v,w=a.find("#rs-top-image"),u=a.find("#rs-digitiser"),m=a.find("#rs-glass");w.bind("load",function(){function t(e){var t=0,a=0;for(console.info(e);e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)console.info("in while"),t+=e.offsetLeft-e.scrollLeft,a+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{top:a,left:t}}u.css("width",w[0].width+"px"),u.css("height",w[0].height+"px"),console.info("rasterSweep img height "+w[0].height),console.info("rasterSweeper",a[0].parentElement),a[0].parentElement.style.height=w[0].height+"px",g=Math.floor(w[0].width/5),v=Math.floor(w[0].width/100),m.css("width",g+"px"),m.css("height",g+"px"),m.css("border-width",v+"px"),w.css("opacity","0");var i=t(u[0]);console.info("new offset left "+i.left+", top "+i.top),u[0].onwheel=function(t){t.preventDefault(),g<w[0].height/2&&g<w[0].width/2&&t.deltaY>0?g+=t.deltaY:g>w[0].height/10&&g>w[0].width/10&&t.deltaY<0&&(g+=t.deltaY),m.css("width",g+"px"),m.css("height",g+"px");var a=t.pageX-i.left,r=t.pageY-i.top;e.clipOverlayImage(g,v,w,a,r);var s=p(h,a,r,g);e.recolorBorder(s,g,m)},u[0].onmousemove=function(a){i=t(u[0]);var r=a.pageX-i.left,s=a.pageY-i.top;e.checkBoundaries(w,g,r,s),e.moveSweeper(m,r,s),e.clipOverlayImage(g,v,w,r,s);var o=p(h,r,s,g);e.recolorBorder(o,g,m)}})})}}}angular.module("rasterSweep",[]).directive("rasterSweep",t).factory("rsHelper",e),e.$inject=[],t.$inject=["rsHelper","$timeout"]}();