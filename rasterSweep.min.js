(function(){"use strict";angular.module("rasterSweep",[]).directive("rasterSweep",a).factory("rsHelper",e);e.$inject=[];function e(){var e={recolorBorder:a,clipOverlayImage:t,moveSweeper:r,checkBoundaries:i,getHSLColor:s,getSingleColorPalette:o};return e;function a(e,a,t){var r=s(e,a);t.css("border-color",r)}function t(e,a,t,r,i){var s=i;var o=t[0].width-e-r-a;var n=t[0].height-e-i-a;var v=r;t.css("clip-path","inset("+s+"px "+o+"px "+n+"px "+v+"px)");t.css("opacity","1")}function r(e,a,t){e.css("left",a+"px");e.css("top",t+"px")}function i(e,a,t,r){if(t>e[0].width-a)t=e[0].width-a;if(t<e[0].offsetLeft)t=e[0].offsetLeft;if(r>e[0].height-a)r=e[0].height-a;if(r<e[0].offsetTop)r=e[0].offsetTop}function s(e,a){var t=a*a;var r=e/t;var i=120-r*120;if(i>100){var s=i-100;var o=50+s*3;return"hsl("+i+", 100%, "+o+"%)"}return"hsl("+i+", 100%, "+"50%)"}function o(e,a,t){var r=t*t;var i=a/r;var s=100-i*100;if(s<80){var s=60-(60-s)/4.5;return"hsl("+e+", 100%, "+s+"%)"}return"hsl("+e+", 100%, "+s+"%)"}}a.$inject=["rsHelper","$timeout"];function a(e,a){return{restrict:"E",scope:{base:"@rsBase",overlay:"@rsOverlay"},template:'<div class="raster-wrapper">'+'<canvas class="rs-canvas" id="rasterSweepCanvas"></canvas>'+'<canvas class="rs-canvas" id="diffCanvas"></canvas>'+'<canvas class="rs-canvas" id="rasterSweepCanvasBg"></canvas>'+'<img id="rs-btn-image" ng-src="{{base}}" alt="original" />'+'<img id="rs-top-image" ng-src="{{overlay}}" alt="original" />'+'<div id="rs-glass"></div>'+'<div id="rs-digitiser"></div>'+"</div>",link:t};function t(a,t,r,i,s){if(!a.base)throw"no base path defined";if(!a.overlay)throw"no overlay path defined";a.$watch("overlay",function(r){console.log("changed overlay path to "+r);var i=a.base;var s=a.overlay;var o=t.find("#rasterSweepCanvas")[0];var n=o.getContext("2d");var v=t.find("#rasterSweepCanvasBg")[0];var c=v.getContext("2d");var h=0;p(i,o,n);p(s,v,c);var f=t.find("#diffCanvas")[0];var d=f.getContext("2d");var l;function g(){f.width=o.width;f.height=o.height;d.putImageData(u(l,n,c),0,0)}function p(e,a,t){var r=new Image;r.src=e;r.onload=function(){a.width=r.width;a.height=r.height;t.drawImage(r,0,0);l=d.createImageData(a.width,a.height);h=h+1;if(h==2){g()}}}function u(e,a,t){var r=a.getImageData(0,0,o.width,o.height),i=t.getImageData(0,0,o.width,o.height);console.info("canvas Breite:"+o.width);console.info("canvas HÃ¶he:"+o.height);pixelmatch(r.data,i.data,e.data,o.width,o.height,{threshold:1e-5,includeAA:true});console.info("diff",e);return e}function w(e,a,t,r){var i=a+r;var s=t+r;var o=0;for(var n=a;n<i;n++){for(var v=t;v<s;v++){var c=e.getImageData(n,v,1,1).data[0];if(c===0){o+=1}}}return o}var m=t.find("#rs-top-image");var x=t.find("#rs-digitiser");var y=t.find("#rs-glass");var C;var I;m.bind("load",function(){function a(e){var a=0;var t=0;while(e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop)){a+=e.offsetLeft-e.scrollLeft;t+=e.offsetTop-e.scrollTop;e=e.offsetParent}return{top:t,left:a}}x.css("width",m[0].width+"px"),x.css("height",m[0].height+"px");t[0].parentElement.style.height=m[0].height+"px";C=Math.floor(m[0].width/5);I=Math.floor(m[0].width/100);y.css("width",C+"px");y.css("height",C+"px");y.css("border-width",I+"px");m.css("opacity","0");var r=a(x[0]);x[0].onwheel=function(a){a.preventDefault();if(C<m[0].height/2&&C<m[0].width/2&&a.deltaY>0){C=C+a.deltaY}else if(C>m[0].height/10&&C>m[0].width/10&&a.deltaY<0){C=C+a.deltaY}y.css("width",C+"px");y.css("height",C+"px");var t=a.pageX-r.left;var i=a.pageY-r.top;e.clipOverlayImage(C,I,m,t,i);var s=w(d,t,i,C);e.recolorBorder(s,C,y)};x[0].onmousemove=function(t){r=a(x[0]);var i=t.pageX-r.left;var s=t.pageY-r.top;e.checkBoundaries(m,C,i,s);e.moveSweeper(y,i,s);e.clipOverlayImage(C,I,m,i,s);var o=w(d,i,s,C);e.recolorBorder(o,C,y)}})})}}})();